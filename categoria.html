<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kategori | FindAalborg</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>
<body class="bg-gray">

    <header class="sticky-header">
        <div class="container header-content">
            <a href="index.html" class="logo">FIND<strong>AALBORG</strong></a>
            <a href="index.html" class="back-link">‚Üê Tilbage</a>
        </div>
    </header>

    <div class="mobile-filter-bar">
        <button onclick="toggleFilters()"><span class="material-icons">filter_list</span> Filtrer & Sorter</button>
        <span id="result-count-mobile">Viser resultater...</span>
    </div>

    <div class="container layout-grid">
        
        <aside class="sidebar" id="filterSidebar">
            <div class="filter-header mobile-only">
                <h3>Filtre</h3>
                <button onclick="toggleFilters()">‚úï</button>
            </div>
            
            <div class="filter-group">
                <h4>Kategorier</h4>
                <div id="cat-filters"></div>
            </div>

            <div class="filter-group">
                <h4>Sorter efter</h4>
                <select id="sort-select" onchange="applyFilters()">
                    <option value="relevance">Anbefalet</option>
                    <option value="rating">Bedste bed√∏mmelse</option>
                    <option value="reviews">Flest anmeldelser</option>
                </select>
            </div>

            <div class="filter-group">
                <h4>Minimum Rating</h4>
                <label><input type="radio" name="rating" value="0" checked onchange="applyFilters()"> Alle</label>
                <label><input type="radio" name="rating" value="4" onchange="applyFilters()"> 4+ Stjerner</label>
                <label><input type="radio" name="rating" value="4.5" onchange="applyFilters()"> 4.5+ Stjerner</label>
            </div>
        </aside>

        <main>
            <div class="page-header">
                <h1 id="page-h1">Kategori</h1>
                <p id="page-intro">Find de bedste steder i Aalborg.</p>
            </div>

            <div id="results-grid" class="cards-list">
                </div>

            <article class="seo-text-block" id="seo-bottom">
                </article>
        </main>
    </div>

    <script>
        let allData = [];
        const params = new URLSearchParams(window.location.search);
        const catParam = params.get('cat');
        const searchParam = params.get('q');

        fetch('datos.json').then(r => r.json()).then(data => {
            allData = data;
            init();
        });

        function init() {
            // Setup Filtros de Categor√≠a
            const cats = [...new Set(allData.map(d => d.kategori))].sort();
            document.getElementById('cat-filters').innerHTML = cats.map(c => 
                `<label class="filter-row">
                    <input type="radio" name="cat" value="${c}" ${c === catParam ? 'checked' : ''} onchange="filterClick('${c}')">
                    <span>${c.replace(' Aalborg', '')}</span>
                </label>`
            ).join('');

            if(catParam) {
                document.getElementById('page-h1').innerText = `${catParam}`;
                document.getElementById('page-intro').innerText = `Her finder du de ${allData.filter(d=>d.kategori===catParam).length} bedste steder inden for ${catParam}.`;
            } else if (searchParam) {
                document.getElementById('page-h1').innerText = `S√∏gning: "${searchParam}"`;
            }

            applyFilters();
        }

        function filterClick(c) {
            // Actualizar URL sin recargar
            const url = new URL(window.location);
            url.searchParams.set('cat', c);
            window.history.pushState({}, '', url);
            applyFilters();
        }

        function applyFilters() {
            // Obtener valores
            const selectedCat = document.querySelector('input[name="cat"]:checked')?.value || catParam;
            const minRating = parseFloat(document.querySelector('input[name="rating"]:checked').value);
            const sortMode = document.getElementById('sort-select').value;

            // Filtrar
            let filtered = allData.filter(item => {
                let match = true;
                if(selectedCat) match = match && item.kategori === selectedCat;
                if(minRating) match = match && parseFloat(item.bedoemmelse.replace(',','.')) >= minRating;
                if(searchParam && !selectedCat) { // B√∫squeda libre si no hay categor√≠a
                    match = match && item.post_title.toLowerCase().includes(searchParam.toLowerCase());
                }
                return match;
            });

            // Ordenar
            if(sortMode === 'rating') {
                filtered.sort((a,b) => parseFloat(b.bedoemmelse.replace(',','.')) - parseFloat(a.bedoemmelse.replace(',','.')));
            } else if (sortMode === 'reviews') {
                filtered.sort((a,b) => (parseInt(b.antal_anmeldelser)||0) - (parseInt(a.antal_anmeldelser)||0));
            }

            renderList(filtered);
        }

        function renderList(items) {
            const container = document.getElementById('results-grid');
            if(items.length === 0) {
                container.innerHTML = '<div class="no-results">Ingen resultater fundet. Pr√∏v at √¶ndre dine filtre.</div>';
                return;
            }

            container.innerHTML = items.map(item => {
                const img = item.billede_url && item.billede_url.length > 10 ? item.billede_url : 'https://images.unsplash.com/photo-1571902943202-507ec2618e8f?w=500';
                return `
                <div class="list-card">
                    <div class="list-img">
                        <img src="${img}" loading="lazy" alt="${item.image_alt_text}">
                    </div>
                    <div class="list-content">
                        <div class="list-header">
                            <div>
                                <span class="cat-label">${item.kategori}</span>
                                <h2><a href="ficha.html?name=${encodeURIComponent(item.post_name)}">${item.post_title}</a></h2>
                            </div>
                            <div class="rating-box">
                                <span class="score">${item.bedoemmelse}</span>
                                <span class="count">/5</span>
                            </div>
                        </div>
                        <div class="list-details">
                            <p>üìç ${item.adresse}</p>
                            <p>üìû ${item.telefon || 'Se nummer'}</p>
                        </div>
                        <div class="list-actions">
                            <a href="ficha.html?name=${encodeURIComponent(item.post_name)}" class="btn-primary">Se detaljer</a>
                            ${item.telefon ? `<a href="tel:${item.telefon}" class="btn-outline mobile-only">Ring</a>` : ''}
                        </div>
                    </div>
                </div>`;
            }).join('');
            
            document.getElementById('result-count-mobile').innerText = `${items.length} resultater`;
        }

        function toggleFilters() {
            document.getElementById('filterSidebar').classList.toggle('active');
        }
    </script>
</body>
</html>
